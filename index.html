<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Scene 1: Gender vs Sleep Quality and Duration</title>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- Load d3-annotation -->
    <script src="https://unpkg.com/d3-svg-annotation@2"></script>
    <style>
        .chart-container {
            margin: 20px;
        }
        .annotation-group {
            font-size: 12px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="scatterplot" class="chart-container"></div>
    <div id="barchart" class="chart-container"></div>
    <script>
        const data = [
            { personId: 1, sleepDuration: 7, sleepQuality: 8, gender: "male", occupation: 1, age: 30 },
            { personId: 2, sleepDuration: 6, sleepQuality: 5, gender: "female", occupation: 2, age: 40 },
            { personId: 3, sleepDuration: 8, sleepQuality: 9, gender: "male", occupation: 3, age: 50 },
            { personId: 4, sleepDuration: 5, sleepQuality: 4, gender: "female", occupation: 1, age: 60 }
        ];

        const scatterPlot = (data, xField, yField, colorField, elementId) => {
            const svg = d3.select(elementId).append("svg").attr("width", 600).attr("height", 400);
            const margin = { top: 20, right: 30, bottom: 40, left: 45 };
            const width = svg.attr("width") - margin.left - margin.right;
            const height = svg.attr("height") - margin.top - margin.bottom;

            const x = d3.scaleLinear().domain([4, 10]).range([0, width]);
            const y = d3.scaleLinear().domain([4, 10]).range([height, 0]);

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            g.append("g").call(d3.axisLeft(y));
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));

             // X Axis Label
             svg.append("text")
                .attr("transform", `translate(${margin.left + width / 2}, ${margin.top + height + 40})`)
                .style("text-anchor", "middle")
                .text("Sleep Duration (hours)");

            // Y Axis Label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", margin.left - 50)
                .attr("x", - (margin.top + height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Sleep Quality (scale 1-10)");

            const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

            const dots = g.selectAll(".dot")
                .data(data)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", d => x(d[xField]))
                .attr("cy", d => y(d[yField]))
                .attr("r", 5)
                .style("fill", function(d) { return d[colorField] === "male" ? "#1f77b4" : "#e377c2"; })
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`Person ID: ${d.personId}<br>Gender: ${d.gender}<br>Occupation: ${d.occupation}<br>Age: ${d.age}<br>Sleep Duration: ${d.sleepDuration}<br>Sleep Quality: ${d.sleepQuality}`)
                           .style("left", (event.pageX + 5) + "px").style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            // Features of the annotations
            const annotations = [
                {
                    note: {
                        label: "High sleep quality and duration",
                        title: "Good Sleep"
                    },
                    type: d3.annotationCalloutRect,
                    subject: {
                        width: 60,
                        height: 60
                    },
                    x: x(8), // Use scale for positioning
                    y: y(8.5),
                    dy: -50,
                    dx: 50
                },
                {
                    note: {
                        label: "Low sleep quality and duration",
                        title: "Poor Sleep"
                    },
                    type: d3.annotationCalloutRect,
                    subject: {
                        width: 60,
                        height: 60
                    },
                    x: x(6), // Use scale for positioning
                    y: y(5),
                    dy: -50,
                    dx: -20
                }
            ];

            // Add annotation to the chart
            const makeAnnotations = d3.annotation()
                .type(d3.annotationLabel) // Ensure the type is set correctly
                .annotations(annotations);

            svg.append("g").attr("class", "annotation-group").call(makeAnnotations);

            // highlight points based on gender selected in bar chart
            function highlightPoints(gender) {
                dots.transition().duration(200)
                    .style("opacity", d => d.gender === gender ? 1 : 0.2);
            }

            // reset opacity of all points
            function resetPoints() {
                dots.transition().duration(200)
                    .style("opacity", 1);
            }

            // Legend

            const legend = svg.append("g")
        .attr("transform", `translate(${width + margin.left + 10}, ${margin.top})`);

            legend.append("circle")
                .attr("cx", 0)
                .attr("cy", 0)
                .attr("r", 5)
                .style("fill", "#1f77b4");

            legend.append("text")
                .attr("x", 10)
                .attr("y", 5)
                .text("Male")
                .style("font-size", "12px")
                .attr("alignment-baseline","middle");

            legend.append("circle")
                .attr("cx", 0)
                .attr("cy", 20)
                .attr("r", 5)
                .style("fill", "#e377c2");

            legend.append("text")
                .attr("x", 10)
                .attr("y", 25)
                .text("Female")
                .style("font-size", "12px")
                .attr("alignment-baseline","middle");

            return { highlightPoints, resetPoints };
        };

        const barChart = (data, elementId) => {
            const svg = d3.select(elementId).append("svg").attr("width", 600).attr("height", 300);
            const margin = { top: 20, right: 30, bottom: 60, left: 70 };
            const width = svg.attr("width") - margin.left - margin.right;
            const height = svg.attr("height") - margin.top - margin.bottom;

            // Calculate average sleep quality and duration by gender
            const avgData = d3.rollup(data, v => ({
                avgSleepQuality: d3.mean(v, d => d.sleepQuality),
                avgSleepDuration: d3.mean(v, d => d.sleepDuration)
            }), d => d.gender);

            const avgDataArray = Array.from(avgData, ([key, value]) => ({ key, ...value }));

            const x = d3.scaleBand().domain(avgDataArray.map(d => d.key)).range([0, width]).padding(0.3);
            const y0 = d3.scaleLinear().domain([0, 10]).range([height, 0]); // Sleep quality scale
            const y1 = d3.scaleLinear().domain([0, 10]).range([height, 0]); // Sleep duration scale

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            g.append("g").call(d3.axisLeft(y0));
            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));

            const barWidth = x.bandwidth() / 2;

            // Function to highlight bars based on gender
            function highlightBars(gender) {
                g.selectAll(".bar-quality")
                    .transition().duration(200)
                    .style("opacity", d => d.key === gender ? 1 : 0.2);
                g.selectAll(".bar-duration")
                    .transition().duration(200)
                    .style("opacity", d => d.key === gender ? 1 : 0.2);
            }

            // Function to reset bars opacity
            function resetBars() {
                g.selectAll(".bar-quality")
                    .transition().duration(200)
                    .style("opacity", 1);
                g.selectAll(".bar-duration")
                    .transition().duration(200)
                    .style("opacity", 1);
            }

            // Bar for average sleep quality
            g.selectAll(".bar-quality")
                .data(avgDataArray)
                .enter().append("rect")
                .attr("class", "bar-quality")
                .attr("x", d => x(d.key))
                .attr("y", d => y0(d.avgSleepQuality))
                .attr("width", barWidth)
                .attr("height", d => height - y0(d.avgSleepQuality))
                .attr("fill", "#1f77b4")
                .on("click", function(event, d) {
                    event.stopPropagation(); // Prevent this event from bubbling up to the body
                    scatterPlotObj.highlightPoints(d.key);
                    highlightBars(d.key);
                });


            // Bar for average sleep duration
            g.selectAll(".bar-duration")
                .data(avgDataArray)
                .enter().append("rect")
                .attr("class", "bar-duration")
                .attr("x", d => x(d.key) + barWidth + 5)  // add space between bars
                .attr("y", d => y1(d.avgSleepDuration))
                .attr("width", barWidth)
                .attr("height", d => height - y1(d.avgSleepDuration))
                .attr("fill", "#ff7f0e")
                .on("click", function(event, d) {
                    event.stopPropagation(); // Prevent this event from bubbling up to the body
                    scatterPlotObj.highlightPoints(d.key);
                    highlightBars(d.key);
                });

            // X Axis Label
            svg.append("text")
                .attr("transform", `translate(${margin.left + width / 2}, ${margin.top + height + 40})`)
                .style("text-anchor", "middle")
                .text("Gender");

            // Y Axis Label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", margin.left - 50)
                .attr("x", - (margin.top + height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Average sleep duration and quality");

            // Legend
            svg.append("rect").attr("x", width - 100).attr("y", 10).attr("width", 10).attr("height", 10).style("fill", "#1f77b4");
            svg.append("text").attr("x", width - 85).attr("y", 20).text("Sleep Quality").style("font-size", "12px").attr("alignment-baseline","middle");
            svg.append("rect").attr("x", width - 100).attr("y", 30).attr("width", 10).attr("height", 10).style("fill", "#ff7f0e");
            svg.append("text").attr("x", width - 85).attr("y", 40).text("Sleep Duration").style("font-size", "12px").attr("alignment-baseline","middle");

            return { highlightBars, resetBars };
        };

        // Render Scatter Plot for Scene 1
        const scatterPlotObj = scatterPlot(data, 'sleepDuration', 'sleepQuality', 'gender', '#scatterplot');

        // Render Bar Chart for Scene 1
        const barChartObj = barChart(data, '#barchart', scatterPlotObj);

        // Add event listener to reset points when clicking outside bars
        document.body.addEventListener('click', function() {
            scatterPlotObj.resetPoints();
            barChartObj.resetBars();
        });

        

    </script>
</body>
</html>



